{% extends "base.html" %}
{% block title %}Group Chat{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
        <h2><i class="fas fa-comments"></i> Group Chat</h2>
        <p class="online-count"><span id="online-users">0</span> users online</p>
    </div>

    <!-- Messages Container -->
    <div class="chat-messages" id="chat-messages">
        {% for message in messages %}
        <div class="message {% if message.sender.id == current_user.id %}message-right{% else %}message-left{% endif %}">
            <div class="message-info">
                <img src="{{ message.sender.profile_pic or url_for('static', filename='images/default-avatar.png') }}" 
                     alt="Profile" class="message-avatar">
                <span class="message-sender">{{ message.sender.name }}</span>
                <span class="message-time">{{ message.timestamp.strftime('%I:%M %p') }}</span>
            </div>
            <div class="message-content">
                {{ message.content }}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Message Input Form -->
    <form id="message-form" class="chat-input-form">
        <div class="input-group">
            <input type="text" id="message-input" class="form-control" placeholder="Type your message..." required>
            <div class="input-group-append">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </form>
</div>

<style>
.chat-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 100px);
    margin: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.chat-header {
    padding: 15px 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #eee;
    border-radius: 10px 10px 0 0;
}

.chat-header h2 {
    margin: 0;
    color: #333;
}

.online-count {
    color: #666;
    font-size: 0.9em;
    margin: 5px 0 0;
}

.chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f5f7f9;
}

.message {
    margin-bottom: 20px;
    max-width: 70%;
}

.message-left {
    float: left;
    clear: both;
}

.message-right {
    float: right;
    clear: both;
}

.message-info {
    margin-bottom: 5px;
    display: flex;
    align-items: center;
}

.message-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 10px;
}

.message-sender {
    font-weight: bold;
    color: #333;
    margin-right: 10px;
}

.message-time {
    font-size: 0.8em;
    color: #999;
}

.message-content {
    padding: 10px 15px;
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.message-right .message-content {
    background: #007bff;
    color: #fff;
}

.chat-input-form {
    padding: 20px;
    background: #f8f9fa;
    border-top: 1px solid #eee;
    border-radius: 0 0 10px 10px;
}

.chat-input-form .input-group {
    background: #fff;
    border-radius: 25px;
    overflow: hidden;
}

.chat-input-form input {
    border: none;
    padding: 15px 20px;
}

.chat-input-form input:focus {
    box-shadow: none;
}

.chat-input-form button {
    padding: 10px 20px;
    border-radius: 0 25px 25px 0;
}

/* Scrollbar Styling */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const messagesContainer = document.getElementById('chat-messages');
    const onlineUsersCount = document.getElementById('online-users');

    // Auto scroll to bottom on load
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    // Handle form submission
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            socket.emit('send_message', { message: message });
            messageInput.value = '';
        }
    });

    // Handle received messages
    socket.on('receive_message', function(data) {
        const isCurrentUser = data.sender_id === {{ current_user.id }};
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isCurrentUser ? 'message-right' : 'message-left'}`;
        
        messageDiv.innerHTML = `
            <div class="message-info">
                <img src="${data.profile_pic || '/static/images/default-avatar.png'}" alt="Profile" class="message-avatar">
                <span class="message-sender">${data.sender_name}</span>
                <span class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            </div>
            <div class="message-content">
                ${data.message}
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });

    // Update online users count
    socket.on('update_users', function(data) {
        onlineUsersCount.textContent = data.count;
    });
});
</script>
{% endblock %}
{% endblock %}